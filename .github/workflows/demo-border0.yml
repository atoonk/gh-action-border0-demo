name: Border0 Demo Workflow
on:
  workflow_dispatch:

jobs:
  deploy-via-border0:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show public IP (Before Border0)
        run: curl -s https://ipinfo.io | jq '{ip, city, region,country, org}'

      - name: Install Border0 CLI
        run: |
          sudo curl -L https://download.border0.com/linux_amd64/border0 -o /usr/local/bin/border0
          sudo chmod +x /usr/local/bin/border0

      - name: Start Border0 VPN with Exit Node
        env:
          BORDER0_TOKEN: ${{ secrets.BORDER0_TOKEN }}
          BORDER0_EXIT_NODE: ${{ secrets.BORDER0_EXIT_NODE }}
        run: |
          echo "$BORDER0_TOKEN" > /tmp/border0.token
          sudo border0 node install --start-vpn --token from:file:/tmp/border0.token
          sleep 5  # Give it a few seconds to initialize and connect to Exit Node
          border0 node exitnode set "$BORDER0_EXIT_NODE"

      - name: Show public IP (After Border0)
        run: curl -s https://ipinfo.io | jq '{ip, city, region,country, org}'

      - name: Configure kubeconfig
        run: border0 client kubeconfig set --service k8-yvr

      - name: Check pods
        run: kubectl get pods
        
      - name: Deploy to Kubernetes
        run: | 
          kubectl apply -f k8-deployment.yaml
          kubectl rollout restart deployment alpine-demo
