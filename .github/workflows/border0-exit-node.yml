name: Border0 Test Workflow

on:
  workflow_dispatch:

jobs:
  test-border0:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: install jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
      - name: Print public IP before
        run: curl -s https://ipinfo.io | jq '{ip, city, region,country, org}'

      - name: Install Border0 CLI
        run: |
          sudo curl -L https://download.border0.com/linux_amd64/border0 \
            -o /usr/local/bin/border0
          sudo chmod +x /usr/local/bin/border0

      - name: Start Border0 VPN and set Exit Node
        env:
          BORDER0_TOKEN: ${{ secrets.BORDER0_TOKEN }}
          BORDER0_EXIT_NODE: ${{ secrets.BORDER0_EXIT_NODE }}
        run: |
          echo "$BORDER0_TOKEN" > /tmp/border0.token
          sudo border0 node install --start-vpn --token from:file:/tmp/border0.token
          sleep 10  # Give it a few seconds to initialize
          border0 node exitnode set "$BORDER0_EXIT_NODE"

      - name: Print public IP after
        run: curl -s https://ipinfo.io | jq '{ip, city, region,country, org}'

      - name: Install kubectl
        run: |
          echo "Installing kubectl..."
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Set Border0 Kubeconfig
        run: |
          border0 client kubeconfig set --service k8-yvr

      - name: Show kubectl config
        run: kubectl config view

      - name: Show Kubernetes cluster info
        run: kubectl cluster-info

      - name: Show nodes
        run: kubectl get nodes

      - name: Show pods
        run: kubectl get pods --all-namespaces

      - name: Show services
        run: kubectl get services --all-namespaces
