name: Border0 DNS split test (Ubuntu)

on:
  workflow_dispatch:

jobs:
  test-border0-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dnsutils

      - name: Install Border0 CLI
        run: |
          sudo curl -L https://download.border0.com/linux_amd64/border0 \
            -o /usr/local/bin/border0
          sudo chmod +x /usr/local/bin/border0

      - name: Start Border0 VPN
        env:
          BORDER0_TOKEN: ${{ secrets.BORDER0_TOKEN }}
        run: |
          set -euxo pipefail
          echo "$BORDER0_TOKEN" > /tmp/border0.token
          sudo border0 node install --start-vpn --token from:file:/tmp/border0.token
          sleep 10

          border0 node status --json | jq .

      - name: Baseline DNS (before split DNS)
        run: |
          set -euxo pipefail

          resolvectl status

          echo "Baseline system resolver:"
          dig -t TXT debug.opendns.com || true
          dig google.com || true

      - name: Apply global split DNS rule (opendns.com -> 208.67.222.22)
        run: |
          set -euxo pipefail

          sudo resolvectl dns utun9 208.67.222.22
          sudo resolvectl domain utun9 ~.opendns.com
          sudo resolvectl flush-caches

          resolvectl status

      - name: Prove split DNS behavior
        run: |
          set -euxo pipefail

          echo "Should resolve via OpenDNS:"
          resolvectl query debug.opendns.com

          echo "TXT record via system resolver (must succeed):"
          dig -t TXT debug.opendns.com

          echo "Should NOT resolve via OpenDNS:"
          resolvectl query google.com
          dig google.com
